#!/opt/bin/sh

# Это временно. Переменную timezone должна определить ndms (прошивка)
# since NDMS 3.0 uses `/usr/share/zoneinfo/posix/rules.txt`
if [ -e "/usr/share/zoneinfo/posix/rules.txt" ]; then
	timezone1=`grep "Moscow" /usr/share/zoneinfo/posix/rules.txt | cut -d ';' -f 2`
	export TZ="$timezone1"
else
	timezone2="Europe/Moscow"
	export TZ=":/usr/share/zoneinfo/posix/$timezone2"
fi

export PATH=$PATH
unset LD_LIBRARY_PATH
unset LD_PRELOAD

case $(mount | grep 'on /opt' | cut -d ' ' -f 5) in
    ext*)
	logger -t installer 'Info: Раздел пригоден для установки.'
    ;;
    *ntfs*)
	logger -t installer 'Info: Раздел NTFS! атрибуты "пользователь:группа" могут не поддерживаться.'
	logger -t installer 'При возникновении проблем, используйте накопитель с файловой системой ext2/ext3/ext4.'
    ;;
    *hfs*)
	logger -t installer 'Info: Раздел с HFS! (!не тестировалось!).'
	logger -t installer 'При возникновении проблем, используйте накопитель с файловой системой ext2/ext3/ext4.'
    ;;
    *)
        logger -t installer 'Critical error: Используйте накопитель с файловой системой ext2/ext3/ext4. Отменяем...'
	exit 1
    ;;
esac

logger -t installer '[1/5] Начало развёртывания системы Entware...'

# This is for opkg only. The other folders will be created from opt-ndmsv2 package
# Только для opkg. Остальные папки будут созданы пакетом opt-ndmsv2
logger -t installer 'Info: Создание папок...'

for folder in lib/opkg tmp var/lock; do
    mkdir -p /opt/$folder
done

logger -t installer '[2/5] Загрузка и установка базовых пакетов...'
opkg update

# for fix `SIGBUS`
opkg install libc

# starting flood
dots.sh &

opkg install opt-ndmsv2 dropbear

# Busybox reinstall
opkg install busybox > /dev/null 2>&1

if [ $? -eq 0 ] ; then
    sleep 5 && logger -t installer 'Info: Установка пакетов прошла успешно! Продолжаем...'
  else
    logger -t installer 'Critical error: Ошибка загрузки? Нет соединения с интернетом? Сервер не отвечает?'
    logger -t installer 'Выход из установки...'
    exit 1
fi

ldconfig > /dev/null 2>&1

# Установка прав для многопользовательской среды
# Fix for multiuser environment
chmod 777 /opt/tmp

logger -t installer '[3/5] Генерация SSH-ключей...'

    rm /opt/etc/dropbear/dropbear_ecdsa_host_key
    dropbearkey -t ecdsa -f /opt/etc/dropbear/dropbear_ecdsa_host_key > /dev/null &
    while [ ! -z "$(pidof dropbearkey)" ] ; do
	sleep 2
	echo -n '.'
    done
    logger -t installer "Info: Ключ ecdsa создан"

    rm /opt/etc/dropbear/dropbear_rsa_host_key
    dropbearkey -t rsa -f /opt/etc/dropbear/dropbear_rsa_host_key -s 1024 > /dev/null &
    while [ ! -z "$(pidof dropbearkey)" ] ; do
	sleep 2
	echo -n '.'
    done
    logger -t installer "Info: Ключ rsa создан"

logger -t installer '[4/5] Установка Entware завершена! Сохранение временной зоны и запуск dropbear...'

timezone=`ndmq -p "show running-config" -P message | awk '/timezone/{print $3}'`
ln -sf /opt/share/zoneinfo/$timezone  /opt/etc/localtime

if [ -f /usr/sbin/dropbear ]; then
    sed -i 's/PORT=22/PORT=222/' /opt/etc/config/dropbear.conf
    dropbear -p 222 -a
  else
    dropbear -p 22 -a
fi

logger -t installer '[5/5] Настройка сценария запуска для прошивки NDMS...'
ndmq -p 'opkg initrc /opt/etc/init.d/rc.unslung'
ndmq -p 'system configuration save'

if grep -q "222" /opt/etc/config/dropbear.conf; then
    logger -t installer 'Можно открыть SSH-сессию для соединения с устройством (ssh root:keenetic@my.keenetic.net -p 222).'
  else
    logger -t installer 'Можно открыть SSH-сессию для соединения с устройством (ssh root:keenetic@my.keenetic.net).'
fi

logger -t installer ''
logger -t installer '@@@@@@@@@@@@@@@@@@@@@@@'
logger -t installer ' Не забудьте сменить пароль и номер порта!'
logger -t installer '@@@@@@@@@@@@@@@@@@@@@@@'
logger -t installer ''

rm $0

#!/opt/bin/sh

# Это временно. Переменную timezone должна определить ndms (прошивка)
timezone="Europe/Moscow"
export TZ=":/usr/share/zoneinfo/posix/$timezone"
export PATH=/opt/sbin:/opt/bin:$PATH
export LANG='ru_RU.UTF-8'
export LC_ALL='ru_RU.UTF-8'
unset LD_LIBRARY_PATH
unset LD_PRELOAD

case $(mount | grep 'on /opt' | cut -d ' ' -f 5) in
    ext2|ext3|ext4)
	logger 'Info: Раздел пригоден для установки.'
    ;;
    *ntfs*)
	logger 'Info: Раздел NTFS! атрибуты "пользователь:группа" могут не поддерживаться.'
	logger 'При возникновении проблем, используйте накопитель с файловой системой ext2/ext3.'
    ;;
    *hfs*)
	logger 'Info: Раздел с HFS! (!не тестировалось!).'
	logger 'При возникновении проблем, используйте накопитель с файловой системой ext2/ext3.'
    ;;
    *)
        logger 'Critical error: Используйте накопитель с файловой системой ext2/ext3. Отменяем...'
	exit 1
    ;;
esac

logger '[1/4] Начало развёртывания системы Entware-Keenetic...'

# This is for opkg only. The other folders will be created from opt-ndmsv2 package
# Только для opkg. Остальные папки будут созданы пакетом opt-ndmsv2
logger 'Info: Создание папок...'

for folder in lib/opkg tmp var/lock; do
    mkdir -p /opt/$folder
done

# Fix for multiuser environment
chmod 777 /opt/tmp

logger '[2/4] Загрузка и установка базовых пакетов...'
opkg update
opkg install opt-ndmsv2 dropbear ndmq

if [ $? -eq 0 ] ; then
    logger 'Info: Установка пакетов прошла успешно! Продолжаем...'
  else
    logger 'Critical error: Ошибка загрузки? Нет соединения с интернет? Сервер не работает?'
    logger 'Выход из установки...'
    exit 1
fi

logger '[3/4] Генерация SSH-ключей...'
dbkey () {
# $1 is a key type [rsa|ecdsa]
    rm /opt/etc/dropbear/dropbear_${1}_host_key
    dropbearkey -t $1 -f /opt/etc/dropbear/dropbear_${1}_host_key > /dev/null &
    while [ ! -z "$(pidof dropbearkey)" ] ; do
	sleep 2
	echo -n '.'
    done
    logger "Info: ключ $1 создан"
}
dbkey rsa
dbkey ecdsa

logger '[4/4] Установка Entware-Keenetic завершена! Сохранение временной зоны и запуск dropbear...'

timezone=`ndmq -p "show running-config" -P message | awk '/timezone/{print $3}'`
ln -sf /opt/share/zoneinfo/$timezone  /opt/etc/localtime
dropbear -p 22 -a

logger 'Готово!!!'
logger 'Можно открыть SSH-сессию для соединения с устройством (логин:пароль -> root:zyxel).'
rm $0
